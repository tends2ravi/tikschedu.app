<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VidQueue - TikTok Direct Post</title>
  <style>
    :root { 
      --primary-color: #4A90E2; 
      --dark-color: #333; 
      --light-gray: #f4f4f4; 
      --success-green: #28a745; 
      --error-red: #dc3545; 
      --muted: #6b7280; 
      --border: #e4e8ee;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 0; padding: 1rem; 
      background: var(--light-gray); 
      color: var(--dark-color); 
      min-height: 100vh; 
      display: flex; flex-direction: column; justify-content: center; align-items: center; 
    }

    .container { 
      background: #fff; 
      max-width: 600px; width: 100%; 
      padding: 2rem 2.5rem; 
      border-radius: 16px; 
      box-shadow: 0 8px 25px rgba(0,0,0,0.1); 
      text-align: center; 
    }

    .logo { width: 60px; height: 60px; margin: 0 auto 1.5rem; display: block; }
    h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
    h2 { font-size: 1.4rem; margin-bottom: 1rem; text-align: left; color: var(--dark-color); }
    p { margin-bottom: 1.0rem; color: #666; line-height: 1.5; }

    .btn { 
      padding: 12px 20px; 
      border-radius: 12px; border: none; 
      cursor: pointer; font-weight: 600; font-size: 1rem; 
      transition: .2s; 
      display: inline-flex; align-items: center; justify-content: center; gap: 10px; 
      width: 100%; 
    }
    .btn-primary { background: var(--primary-color); color: #fff; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(74,144,226,.4); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-ghost { background: #eef2f7; color: #333; margin-top: 10px; }

    .section { display: none; animation: fadeIn .4s ease-in-out; }
    .active { display: block; }
    .loading { display: none; padding: 2rem; }
    .spinner { 
      width: 40px; height: 40px; margin: 0 auto 1rem; 
      border: 4px solid rgba(0,0,0,0.1); border-radius: 50%; 
      border-top-color: var(--primary-color); 
      animation: spin 1s linear infinite; 
    }

    /* Creator Profile */
    .creator-profile { 
      display: flex; align-items: center; 
      background: #f7f9fc; 
      padding: 12px; border-radius: 12px; 
      margin-bottom: 20px; border: 1px solid var(--border); 
    }
    .avatar { width: 42px; height: 42px; border-radius: 50%; background: #ddd; margin-right: 12px; object-fit: cover; }
    .creator-info { text-align: left; }
    .creator-name { font-weight: bold; font-size: 0.95rem; display: block; color: var(--dark-color); }
    .creator-handle { color: var(--muted); font-size: 0.85rem; }

    /* Form Elements */
    .form-group { text-align: left; margin-bottom: 18px; }
    .form-label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; color: var(--dark-color); }
    .form-control { 
      width: 100%; padding: 10px; 
      border-radius: 8px; border: 1px solid #ccc; 
      font-size: 1rem; box-sizing: border-box; 
      transition: border-color 0.2s;
    }
    .form-control:focus { outline: none; border-color: var(--primary-color); }

    /* Toggles */
    .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; text-align: left; }
    .toggle-label { font-size: 0.95rem; color: var(--dark-color); }
    
    .switch { position: relative; display: inline-block; width: 46px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(20px); }
    input:disabled + .slider { background-color: #eee; cursor: not-allowed; }

    .disclosure-box { 
      background: #f8f9fa; padding: 15px; 
      border-radius: 8px; border: 1px solid var(--border); 
      margin-top: 20px; text-align: left; 
      font-size: 0.8rem; color: #666; line-height: 1.4;
    }
    .disclosure-box a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
    
    .commercial-options { margin-left: 10px; padding-left: 15px; border-left: 2px solid var(--border); margin-top: 10px; display: none; }
    .commercial-options.show { display: block; }
    .checkbox-group { display: block; margin-bottom: 8px; font-size: 0.9rem; text-align: left; cursor: pointer; }
    
    .progress-wrap { background: #e9edf3; border-radius: 10px; overflow: hidden; height: 10px; margin: 20px 0; }
    .progress-bar { height: 10px; width: 0%; background: linear-gradient(90deg, #4A90E2, #7db4f1); transition: width .3s ease; }
    
    .status-pill { display: inline-block; padding: 6px 14px; border-radius: 20px; background: #eef2f7; color: #555; font-size: 0.85rem; font-weight: 600; }
    .log-container {
      background: #1e1e1e; color: #0f0; font-family: 'Courier New', monospace; font-size: 11px; 
      text-align: left; padding: 10px; border-radius: 8px; margin-top: 15px; height: 120px; overflow-y: auto; border: 1px solid #333;
    }
    
    /* Footer Links */
    .footer { margin-top: 2rem; font-size: .9rem; color: #888; }
    .footer a { color: #555; text-decoration: none; margin: 0 10px; transition: color 0.2s; }
    .footer a:hover { color: var(--primary-color); text-decoration: underline; }

    @keyframes fadeIn { from { opacity: 0; transform: scale(.98); } to { opacity: 1; transform: scale(1); } }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="container">
    <svg class="logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M17.5 3H6.5C4.29086 3 2.5 4.79086 2.5 7V17C2.5 19.2091 4.29086 21 6.5 21H17.5C19.7091 21 21.5 19.2091 21.5 17V7C21.5 4.79086 19.7091 3 17.5 3Z" stroke="#4A90E2" stroke-width="1.5"/>
      <path d="M15.5 12L10.5 9.26795V14.7321L15.5 12Z" stroke="#4A90E2" stroke-width="1.5" stroke-linejoin="round"/>
    </svg>

    <div id="login-section" class="section active">
      <h1>Welcome to VidQueue</h1>
      <p>Securely connect to TikTok to schedule and post.</p>
      <button class="btn btn-primary" id="login-btn">Continue with TikTok</button>
      <p style="font-size:0.75rem; margin-top:20px; opacity:0.7;">Secured by PKCE & HttpOnly Cookies</p>
    </div>

    <div id="loading-section" class="loading">
      <div class="spinner"></div>
      <p class="muted" id="loading-text">Processing...</p>
    </div>

    <div id="config-section" class="section">
      <h2>New Post</h2>
      
      <div class="creator-profile">
        <img src="" class="avatar" id="avatar-img" alt="">
        <div class="creator-info">
          <span class="creator-name" id="profile-name">Loading...</span>
          <span class="creator-handle" id="profile-handle">@tiktok_account</span>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Video Source</label>
        <p class="muted" style="font-size:0.75rem; margin-bottom:5px;">Select a video file to upload (Direct File Upload Mode)</p>
        <input type="file" id="video-file" class="form-control" accept="video/*">
      </div>

      <div class="form-group">
        <label class="form-label">Caption</label>
        <textarea class="form-control" id="post-caption" rows="2" placeholder="Write a caption..."></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Who can watch this video? <span style="color:var(--error-red)">*</span></label>
        <select id="privacy-select" class="form-control">
          <option value="" disabled selected>Select privacy setting</option>
          </select>
        <p class="muted" id="privacy-warning" style="font-size:0.8rem; margin-top:5px; color:var(--error-red);"></p>
      </div>

      <div class="form-group">
        <label class="form-label">Allow users to:</label>
        <div class="toggle-row">
          <span class="toggle-label">Comment</span>
          <label class="switch"><input type="checkbox" id="allow-comment" checked><span class="slider"></span></label>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Duet</span>
          <label class="switch"><input type="checkbox" id="allow-duet" checked><span class="slider"></span></label>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Stitch</span>
          <label class="switch"><input type="checkbox" id="allow-stitch" checked><span class="slider"></span></label>
        </div>
      </div>

      <div class="form-group" style="border-top: 1px solid var(--border); padding-top:15px; margin-top:20px;">
        <div class="toggle-row">
          <span class="toggle-label" style="font-weight:600; color:var(--dark-color);">Content Disclosure</span>
          <label class="switch">
            <input type="checkbox" id="commercial-toggle"><span class="slider"></span>
          </label>
        </div>
        <div id="commercial-details" class="commercial-options">
          <label class="checkbox-group">
            <input type="checkbox" id="brand-own"> Your brand
          </label>
          <label class="checkbox-group">
            <input type="checkbox" id="brand-other"> Branded content
          </label>
        </div>
      </div>

      <div class="disclosure-box">
        <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer;">
          <input type="checkbox" id="consent-check">
          <span id="consent-text" style="margin-top:2px;">
            By posting, you agree to TikTok's <a href="#" onclick="return false;">Music Usage Confirmation</a>.
          </span>
        </label>
      </div>

      <button id="btn-post" class="btn btn-primary" style="margin-top:20px;">Post to TikTok</button>
    </div>

    <div id="upload-status-section" class="section">
      <h2>Publishing...</h2>
      <div class="progress-wrap"><div id="progress-bar" class="progress-bar"></div></div>
      <div style="text-align:left;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <strong>Status:</strong>
          <span id="status-text" class="status-pill">Initializing...</span>
        </div>
        <div class="log-container" id="log-console"><div>> Ready.</div></div>
      </div>
      <button id="btn-reset" class="btn btn-ghost" style="display:none;" onclick="location.reload()">Start Over</button>
    </div>
  </div>

  <footer class="footer">
    <p>
      <a href="https://vidqueue.online/terms-of-service.html" target="_blank" rel="noopener noreferrer">Terms of Service</a> | 
      <a href="https://vidqueue.online/privacy-policy.html" target="_blank" rel="noopener noreferrer">Privacy Policy</a>
    </p>
  </footer>

  <script>
    // --- CONFIGURATION ---
    const API_BASE = 'https://api.vidqueue.online/api/tiktok';
    const CLIENT_KEY = 'awhpiezul6kqqmt4'; // Your Client Key
    const REDIRECT_URI = 'https://vidqueue.online/app.html';

    // --- UTILS ---
    const sections = {
      login: document.getElementById('login-section'),
      loading: document.getElementById('loading-section'),
      config: document.getElementById('config-section'),
      upload: document.getElementById('upload-status-section')
    };

    function showSection(name) {
      Object.values(sections).forEach(el => el.classList.remove('active'));
      sections[name].classList.add('active');
    }

    function log(msg) {
      const el = document.getElementById('log-console');
      el.innerHTML += `<div>> ${msg}</div>`;
      el.scrollTop = el.scrollHeight;
    }

    // --- PKCE HELPERS ---
    function randBase64Url(len) {
      const bytes = new Uint8Array(len);
      crypto.getRandomValues(bytes);
      return btoa(String.fromCharCode(...bytes)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // --- API HELPER (With Cookies) ---
    async function apiPost(endpoint, body) {
      try {
        const res = await fetch(API_BASE + endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', // Sends HttpOnly Cookie
          body: JSON.stringify(body || {})
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'API Error');
        return data;
      } catch (e) {
        log(`Error: ${e.message}`);
        throw e;
      }
    }

    // --- UI ENFORCEMENT (Compliance) ---
    function enforceUI() {
      const privacy = document.getElementById('privacy-select').value;
      const isBranded = document.getElementById('commercial-toggle').checked;
      const consentText = document.getElementById('consent-text');
      const warning = document.getElementById('privacy-warning');

      // 1. Update Consent Text
      if (isBranded) {
        document.getElementById('commercial-details').classList.add('show');
        consentText.innerHTML = `By posting, you agree to TikTok's <a href="#" onclick="return false;">Music Usage Confirmation</a> and <a href="#" onclick="return false;">Branded Content Policy</a>.`;
      } else {
        document.getElementById('commercial-details').classList.remove('show');
        consentText.innerHTML = `By posting, you agree to TikTok's <a href="#" onclick="return false;">Music Usage Confirmation</a>.`;
      }

      // 2. Enforce Privacy Rules
      if (isBranded && privacy === 'SELF_ONLY') {
        warning.textContent = "Branded content cannot be Private.";
        document.getElementById('btn-post').disabled = true;
      } else if (!privacy) {
        warning.textContent = "Privacy selection is required.";
        document.getElementById('btn-post').disabled = true;
      } else {
        warning.textContent = "";
        document.getElementById('btn-post').disabled = false;
      }

      // 3. Interactions Logic
      if (privacy === 'SELF_ONLY') {
        document.getElementById('allow-duet').disabled = true;
        document.getElementById('allow-duet').checked = false;
        document.getElementById('allow-stitch').disabled = true;
        document.getElementById('allow-stitch').checked = false;
      } else {
        document.getElementById('allow-duet').disabled = false;
        document.getElementById('allow-stitch').disabled = false;
      }
    }

    // Event Listeners for UI
    document.getElementById('privacy-select').addEventListener('change', enforceUI);
    document.getElementById('commercial-toggle').addEventListener('change', enforceUI);

    // --- 1. AUTH FLOW ---
    document.getElementById('login-btn').addEventListener('click', async () => {
       const state = randBase64Url(32);
       const verifier = randBase64Url(64);
       const challenge = await sha256(verifier);

       localStorage.setItem('tt_state', state);
       localStorage.setItem('tt_verifier', verifier);

       const params = new URLSearchParams({
          client_key: CLIENT_KEY,
          response_type: 'code',
          // FIX: REMOVE 'video.upload'. USE ONLY 'video.publish'
          scope: 'user.info.basic,video.publish', 
          redirect_uri: REDIRECT_URI,
          state: state,
          code_challenge: challenge,
          code_challenge_method: 'S256'
        });
        window.location.href = 'https://www.tiktok.com/v2/auth/authorize/?' + params.toString();
    });

    // Handle Callback
    window.onload = async () => {
      const qs = new URLSearchParams(window.location.search);
      const code = qs.get('code');
      const state = qs.get('state');

      if (code && state) {
        handleAuth(code, state);
      }
    };

    async function handleAuth(code, state) {
      showSection('loading');
      const storedState = localStorage.getItem('tt_state');
      const verifier = localStorage.getItem('tt_verifier');

      if (state !== storedState) return alert("Security Error: State mismatch");

      document.getElementById('loading-text').textContent = "Securing Session...";
      
      // Exchange Code
      try {
        await apiPost('/exchange_code', { code, code_verifier: verifier, redirect_uri: REDIRECT_URI });
        
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // Fetch Creator Info
        fetchCreatorInfo();
      } catch (e) {
        alert("Login failed: " + e.message);
        showSection('login');
      }
    }

    async function fetchCreatorInfo() {
      document.getElementById('loading-text').textContent = "Loading Profile...";
      try {
        const res = await apiPost('/creator_info');
        const data = res.data;

        document.getElementById('profile-name').textContent = data.display_name;
        document.getElementById('avatar-img').src = data.avatar_url;

        // Fill Privacy Options from API
        const select = document.getElementById('privacy-select');
        select.innerHTML = '<option value="" disabled selected>Select privacy setting</option>';
        data.privacy_level_options.forEach(opt => {
           const option = document.createElement('option');
           option.value = opt;
           option.textContent = opt;
           select.appendChild(option);
        });

        showSection('config');
      } catch (e) {
        alert("Could not load profile. Ensure backend is running.");
        showSection('login');
      }
    }

    // --- 2. POSTING FLOW (FILE_UPLOAD MODE) ---
    document.getElementById('btn-post').addEventListener('click', async () => {
      const consent = document.getElementById('consent-check').checked;
      if (!consent) return alert("You must agree to the consent terms.");

      startUploadProcess();
    });

    async function startUploadProcess() {
      const fileInput = document.getElementById('video-file');
      const file = fileInput.files[0];

      // CRITICAL: You must select a real file now
      if (!file) return alert("Please select a video file from your computer.");
      
      showSection('upload');
      log("Initializing FILE_UPLOAD...");
      document.getElementById('status-text').textContent = "Initializing...";

      try {
        // 1. Init: Pass video_size to Backend
        // The backend uses this to generate the upload URL
        const init = await apiPost('/direct_post_init', { 
            video_size: file.size 
        });
        
        if (!init.data || !init.data.upload_url) {
          throw new Error(init.error || "No upload_url received from TikTok");
        }

        const uploadUrl = init.data.upload_url;
        const publishId = init.data.publish_id;
        log(`Init Success. ID: ${publishId}`);

        // 2. Upload: Send File Directly to TikTok
        log("Uploading binary to TikTok...");
        document.getElementById('status-text').textContent = "Uploading...";
        
        // Native fetch PUT to TikTok's upload URL
        const uploadRes = await fetch(uploadUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': 'video/mp4',
            'Content-Range': `bytes 0-${file.size - 1}/${file.size}`
          },
          body: file
        });

        if (!uploadRes.ok) {
           const errText = await uploadRes.text();
           throw new Error("Upload Failed: " + errText);
        }
        
        log("Binary Upload Complete.");

        // 3. Poll Status
        let w = 0; 
        const bar = document.getElementById('progress-bar');
        setInterval(() => { if(w<90) bar.style.width = (w+=5)+'%' }, 500);

        pollStatus(publishId);

      } catch (e) {
        log("Error: " + e.message);
        document.getElementById('status-text').textContent = "Failed";
        document.getElementById('status-text').style.color = "red";
      }
    }

    async function pollStatus(id) {
      document.getElementById('status-text').textContent = "Processing...";
      const interval = setInterval(async () => {
        log("Checking status...");
        const res = await apiPost('/status_fetch', { publish_id: id });
        
        if (res.data.status === 'PUBLISH_COMPLETE') {
          clearInterval(interval);
          document.getElementById('progress-bar').style.width = '100%';
          document.getElementById('status-text').textContent = "PUBLISH_COMPLETE";
          document.getElementById('status-text').style.color = "green";
          log("Done!");
          document.getElementById('btn-reset').style.display = 'inline-block';
          alert("Success!");
        }
      }, 3000);
    }
  </script>
</body>
</html>