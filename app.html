<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VidQueue - TikTok Video Scheduler</title>
  <style>
    :root { --primary-color:#4A90E2; --dark-color:#333; --light-gray:#f4f4f4; --success-green:#28a745; --error-red:#dc3545; --muted:#6b7280; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; margin:0; padding:1rem; background:var(--light-gray); color:var(--dark-color); min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .container { background:#fff; max-width:600px; width:100%; padding:2rem 2.5rem; border-radius:16px; box-shadow:0 8px 25px rgba(0,0,0,0.1); text-align:center; }
    .logo { width:60px; height:60px; margin:0 auto 1.5rem; display:block; }
    h1 { font-size:1.8rem; margin-bottom:.5rem; }
    p { margin-bottom:1.0rem; color:#666; line-height:1.5; }
    .btn { padding:12px 20px; border-radius:12px; border:none; cursor:pointer; font-weight:600; font-size:1rem; transition:.2s; display:inline-flex; align-items:center; justify-content:center; gap:10px; }
    .btn-primary { background:var(--primary-color); color:#fff; }
    .btn-primary:hover { transform:translateY(-3px); box-shadow:0 4px 15px rgba(74,144,226,.4); }
    .btn-ghost { background:#eef2f7; color:#333; }
    .section { display:none; animation:fadeIn .4s ease-in-out; }
    .active { display:block; }
    .loading { display:none; padding:2rem; }
    .spinner { width:40px; height:40px; margin:0 auto 1rem; border:4px solid rgba(0,0,0,0.1); border-radius:50%; border-top-color:var(--primary-color); animation:spin 1s linear infinite; }
    .alert { padding:1.0rem; border-radius:12px; margin:1.0rem 0; border-left:5px solid; text-align:left; }
    .alert-success { background:rgba(40,167,69,.08); border-left-color:var(--success-green); }
    .alert-error { background:rgba(220,53,69,.08); border-left-color:var(--error-red); }
    .token-display { background:#f0f0f0; padding:1rem; border-radius:8px; word-break:break-all; text-align:left; margin-top:1rem; }
    .footer { margin-top:2rem; font-size:.9rem; color:#888; }
    .footer a { color:#555; text-decoration:none; margin:0 10px; }
    .footer a:hover { text-decoration:underline; }
    .row { display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
    .muted { color:var(--muted); font-size:.9rem; }
    .uploader { text-align:left; background:#f7f9fc; border:1px solid #e4e8ee; border-radius:12px; padding:14px; margin-top:12px; }
    .uploader h4 { margin:0 0 6px 0; }
    .progress-wrap { background:#e9edf3; border-radius:10px; overflow:hidden; height:10px; margin:10px 0; }
    .progress-bar { height:10px; width:0%; background:linear-gradient(90deg, #4A90E2, #7db4f1); transition:width .25s ease; }
    .log { background:#fff; border:1px solid #e4e8ee; border-radius:8px; padding:10px; max-height:140px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; }
    .kbd { background:#eef2f7; border:1px solid #d8dee8; padding:2px 6px; border-radius:6px; font-family:ui-monospace, monospace; font-size:12px; }
    @keyframes fadeIn { from { opacity:0; transform:scale(.98);} to { opacity:1; transform:scale(1);} }
    @keyframes spin { to { transform:rotate(360deg);} }
  </style>
</head>
<body>
  <div class="container">
    <svg class="logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 3H6.5C4.29086 3 2.5 4.79086 2.5 7V17C2.5 19.2091 4.29086 21 6.5 21H17.5C19.7091 21 21.5 19.2091 21.5 17V7C21.5 4.79086 19.7091 3 17.5 3Z" stroke="#4A90E2" stroke-width="1.5"/><path d="M15.5 12L10.5 9.26795V14.7321L15.5 12Z" stroke="#4A90E2" stroke-width="1.5" stroke-linejoin="round"/></svg>

    <!-- Login -->
    <div id="login-section" class="section active">
      <h1>Welcome to VidQueue</h1>
      <p>Sign in with TikTok to continue.</p>
      <button class="btn btn-primary" id="login-btn">Continue with TikTok</button>
    </div>

    <!-- Loading -->
    <div id="loading-section" class="loading">
      <div class="spinner"></div>
      <p class="muted">Authorizingâ€¦</p>
    </div>

    <!-- Error -->
    <div id="error-section" class="section">
      <div class="alert alert-error">
        <h3>Authorization Failed</h3>
        <p id="error-message"></p>
      </div>
      <button id="retry-btn" class="btn btn-primary">Try Again</button>
    </div>

    <!-- Success (code captured) -->
    <div id="success-section" class="section">
      <div class="alert alert-success">
        <h3>Authorization Successful! ðŸŽ‰</h3>
        <p class="muted">Your authorization code is below; your backend should exchange it for tokens.</p>
      </div>
      <div class="token-display">
        <strong>Code:</strong> <code id="auth-code"></code>
      </div>
      <div class="row" style="margin-top:12px;">
        <button id="open-upload-demo" class="btn btn-ghost">Open upload workflow</button>
      </div>
      <button id="copy-btn" class="btn" style="margin-top:10px;">Copy Code</button>
    </div>

    <!-- Upload workflow (init â†’ upload â†’ publish/schedule) -->
    <div id="upload-demo-section" class="section">
      <div class="alert alert-success">
        <h3>Upload & scheduling</h3>
        <p class="muted">Use this flow to initialize an upload, track progress, and then publish or schedule a post.</p>
      </div>

      <div class="uploader">
        <h4>1) Initialize upload</h4>
        <p class="muted">Choose a local file or paste a video URL.</p>
        <div class="row">
          <input id="demo-file" type="file" accept="video/*">
          <input id="demo-url" type="url" placeholder="https://example.com/video.mp4" style="flex:1; min-width:240px; padding:8px; border:1px solid #e4e8ee; border-radius:8px;">
        </div>
        <div class="row" style="margin-top:10px;">
          <button id="btn-init" class="btn btn-primary">Init</button>
        </div>
      </div>

      <div class="uploader">
        <h4>2) Upload progress</h4>
        <p class="muted">Simulated chunk transfer to the upload URL returned by init.</p>
        <div class="progress-wrap"><div id="progress-bar" class="progress-bar"></div></div>
        <div class="row">
          <button id="btn-start-upload" class="btn btn-primary" disabled>Start upload</button>
          <span id="upload-status" class="muted">Waiting for initâ€¦</span>
        </div>
      </div>

      <div class="uploader">
        <h4>3) Publish or schedule</h4>
        <p class="muted">Finalize by posting immediately or scheduling a future time.</p>
        <div class="row">
          <button id="btn-publish" class="btn btn-primary" disabled>Publish now</button>
          <button id="btn-schedule" class="btn btn-ghost" disabled>Schedule (+10 min)</button>
        </div>
      </div>

      <div class="uploader">
        <h4>Activity log</h4>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>
      <a href="./terms-of-service.html" target="_blank" rel="noopener noreferrer">Terms of Service</a> |
      <a href="./privacy-policy.html" target="_blank" rel="noopener noreferrer">Privacy Policy</a>
    </p>
  </footer>

  <script>
    // Config
    const CLIENT_KEY = 'sbawbj2jcdabtqkzi0';
    const REDIRECT_URI = window.location.href.split('?')[0];

    const sections = {
      login: document.getElementById('login-section'),
      loading: document.getElementById('loading-section'),
      error: document.getElementById('error-section'),
      success: document.getElementById('success-section'),
      upload: document.getElementById('upload-demo-section')
    };

    // PKCE helpers
    function generateCodeVerifier() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      return Array.from(crypto.getRandomValues(new Uint8Array(64))).map(b => chars[b % chars.length]).join('');
    }
    async function generateCodeChallenge(verifier) {
      const data = new TextEncoder().encode(verifier);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }

    function show(id) { Object.values(sections).forEach(s => s.classList.remove('active')); sections[id].classList.add('active'); }
    function showError(msg) { document.getElementById('error-message').textContent = msg || 'Unknown error.'; show('error'); }

    async function startOAuth() {
      try {
        show('loading');
        const state = generateCodeVerifier().slice(0, 16);
        const codeVerifier = generateCodeVerifier();
        const codeChallenge = await generateCodeChallenge(codeVerifier);
        sessionStorage.setItem('pkce_state', state);
        sessionStorage.setItem('pkce_verifier', codeVerifier);

        const params = new URLSearchParams({
          client_key: CLIENT_KEY,
          response_type: 'code',
          redirect_uri: REDIRECT_URI,
          scope: 'user.info.basic,video.upload,video.publish',
          state,
          code_challenge: codeChallenge,
          code_challenge_method: 'S256'
        });
        window.location.href = 'https://www.tiktok.com/v2/auth/authorize/?' + params.toString();
      } catch (e) {
        showError('Failed to start authorization: ' + (e?.message || e));
      }
    }

    function handleCallback() {
      const qs = new URLSearchParams(window.location.search);
      const code = qs.get('code');
      const state = qs.get('state');
      const err = qs.get('error');
      const errDesc = qs.get('error_description');
      if (err) { showError((errDesc ? errDesc + ' â€” ' : '') + 'Error: ' + err); return; }
      if (!code) { show('login'); return; }
      if (state !== sessionStorage.getItem('pkce_state')) { showError('Security check failed (state mismatch).'); return; }
      document.getElementById('auth-code').textContent = code;
      show('success');
    }

    document.getElementById('login-btn').addEventListener('click', startOAuth);
    document.getElementById('retry-btn').addEventListener('click', () => location.href = REDIRECT_URI);
    document.getElementById('copy-btn').addEventListener('click', () => {
      const val = document.getElementById('auth-code').textContent;
      navigator.clipboard.writeText(val).then(() => alert('Authorization code copied.'));
    });

    // Upload workflow logic (still simulated client-side)
    const logEl = document.getElementById('log');
    const pb = document.getElementById('progress-bar');
    const statusEl = document.getElementById('upload-status');
    const btnInit = document.getElementById('btn-init');
    const btnStart = document.getElementById('btn-start-upload');
    const btnPublish = document.getElementById('btn-publish');
    const btnSchedule = document.getElementById('btn-schedule');
    const openDemo = document.getElementById('open-upload-demo');
    const fileInput = document.getElementById('demo-file');
    const urlInput = document.getElementById('demo-url');

    let mockUploadUrl = null;
    let mockPublishId = null;
    let progress = 0;
    let timer = null;

    function log(msg) {
      const ts = new Date().toLocaleTimeString();
      logEl.textContent += `[${ts}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    openDemo.addEventListener('click', () => {
      sections.upload.classList.add('active');
      document.getElementById('upload-demo-section').scrollIntoView({ behavior: 'smooth' });
      log('Opened upload workflow.');
    });

    btnInit.addEventListener('click', () => {
      const hasFile = fileInput.files && fileInput.files.length > 0;
      const hasUrl = urlInput.value.trim().length > 0;
      if (!hasFile && !hasUrl) {
        alert('Select a local file or paste a video URL.');
        return;
      }
      mockUploadUrl = 'https://upload.mock.tiktokapis.com/v2/post/upload_url';
      mockPublishId = null;
      btnStart.disabled = false;
      statusEl.textContent = 'Init complete. Upload URL ready.';
      log('Init: upload session created (simulated).');
    });

    btnStart.addEventListener('click', () => {
      if (!mockUploadUrl) {
        alert('Run init first.');
        return;
      }
      btnStart.disabled = true;
      progress = 0;
      pb.style.width = '0%';
      statusEl.textContent = 'Uploadingâ€¦';
      log('Uploading chunks to upload URL (simulated).');

      timer = setInterval(() => {
        progress = Math.min(100, progress + Math.floor(Math.random()*15) + 5);
        pb.style.width = progress + '%';
        if (progress >= 100) {
          clearInterval(timer);
          statusEl.textContent = 'Upload complete.';
          btnPublish.disabled = false;
          btnSchedule.disabled = false;
          log('Upload complete (simulated).');
        }
      }, 400);
    });

    btnPublish.addEventListener('click', () => {
      mockPublishId = 'v_post_' + Math.floor(Math.random()*1e9);
      const logId = 'LOG-' + Math.floor(Math.random()*1e6).toString(16).toUpperCase();
      log(`Publish: video.publish called â†’ publish_id=${mockPublishId}, log_id=${logId} (simulated).`);
      alert('Published: ' + mockPublishId);
    });

    btnSchedule.addEventListener('click', () => {
      const eta = new Date(Date.now() + 10*60*1000).toLocaleTimeString();
      mockPublishId = 'v_scheduled_' + Math.floor(Math.random()*1e9);
      const logId = 'LOG-' + Math.floor(Math.random()*1e6).toString(16).toUpperCase();
      log(`Schedule: video.publish with schedule_time â†’ publish_id=${mockPublishId}, log_id=${logId}, eta=${eta} (simulated).`);
      alert('Scheduled for ~10 minutes: ' + mockPublishId);
    });

    window.addEventListener('load', handleCallback);
  </script>
</body>
</html>
