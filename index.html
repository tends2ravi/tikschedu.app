<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"> <!-- Login Kit web app basics -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VidQueue - TikTok Video Scheduler</title>
  <style>
    :root { --primary-color:#4A90E2; --dark-color:#333; --light-gray:#f4f4f4; --success-green:#28a745; --error-red:#dc3545; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; margin:0; padding:1rem; background:var(--light-gray); color:var(--dark-color); min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .container { background:#fff; max-width:550px; width:100%; padding:2rem 2.5rem; border-radius:16px; box-shadow:0 8px 25px rgba(0,0,0,0.1); text-align:center; }
    .logo { width:60px; height:60px; margin:0 auto 1.5rem; display:block; }
    h1 { font-size:1.8rem; margin-bottom:.5rem; }
    p { margin-bottom:1.5rem; color:#666; line-height:1.5; }
    .btn { padding:14px 28px; border-radius:12px; border:none; cursor:pointer; font-weight:600; font-size:1rem; transition:.2s; display:inline-flex; align-items:center; justify-content:center; gap:10px; }
    .btn-primary { background:var(--primary-color); color:#fff; }
    .btn-primary:hover { transform:translateY(-3px); box-shadow:0 4px 15px rgba(74,144,226,.4); }
    .section { display:none; animation:fadeIn .4s ease-in-out; }
    .active { display:block; }
    .loading { display:none; padding:2rem; }
    .spinner { width:40px; height:40px; margin:0 auto 1rem; border:4px solid rgba(0,0,0,0.1); border-radius:50%; border-top-color:var(--primary-color); animation:spin 1s linear infinite; }
    .alert { padding:1.25rem; border-radius:12px; margin:1.5rem 0; border-left:5px solid; text-align:left; }
    .alert-success { background:rgba(40,167,69,.1); border-left-color:var(--success-green); }
    .alert-error { background:rgba(220,53,69,.1); border-left-color:var(--error-red); }
    .token-display { background:#f0f0f0; padding:1rem; border-radius:8px; word-break:break-all; text-align:left; position:relative; margin-top:1rem; }
    .footer { margin-top:2rem; font-size:.9rem; color:#888; }
    .footer a { color:#555; text-decoration:none; margin:0 10px; }
    .footer a:hover { text-decoration:underline; }
    .user-row { display:flex; align-items:center; gap:12px; }
    .avatar { width:48px; height:48px; border-radius:50%; object-fit:cover; background:#e5e7eb; }
    .muted { color:#666; font-size:.9rem; }
    @keyframes fadeIn { from { opacity:0; transform:scale(.98);} to { opacity:1; transform:scale(1);} }
    @keyframes spin { to { transform:rotate(360deg);} }
  </style>
</head>
<body>
  <div class="container">
    <svg class="logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 3H6.5C4.29086 3 2.5 4.79086 2.5 7V17C2.5 19.2091 4.29086 21 6.5 21H17.5C19.7091 21 21.5 19.2091 21.5 17V7C21.5 4.79086 19.7091 3 17.5 3Z" stroke="#4A90E2" stroke-width="1.5"/><path d="M15.5 12L10.5 9.26795V14.7321L15.5 12Z" stroke="#4A90E2" stroke-width="1.5" stroke-linejoin="round"/></svg>

    <div id="login-section" class="section active">
      <h1>Welcome to VidQueue</h1>
      <p>The smart way to schedule your video content; connect your TikTok account to get started.</p>
      <button class="btn btn-primary" id="login-btn">Continue with TikTok</button>
    </div>

    <div id="loading-section" class="loading">
      <div class="spinner"></div>
      <p>Connecting securely to TikTok...</p>
    </div>

    <div id="error-section" class="section">
      <div class="alert alert-error">
        <h3>Authorization Failed</h3>
        <p id="error-message"></p>
      </div>
      <button id="retry-btn" class="btn btn-primary">Try Again</button>
    </div>

    <div id="success-section" class="section">
      <div class="alert alert-success">
        <h3>Authorization Successful! ðŸŽ‰</h3>
        <p>Your authorization code is ready; your backend should exchange it for tokens using the OAuth v2 token endpoint.</p>
      </div>
      <div class="token-display">
        <strong>Code:</strong> <code id="auth-code"></code>
      </div>
      <button id="copy-btn" class="btn">Copy Code</button>
    </div>

    <!-- New: user.info.basic demo (render after token exchange + user info call) -->
    <div id="user-card" class="section">
      <div class="alert alert-success">
        <h3>Signed in user</h3>
        <div class="user-row">
          <img id="user-avatar" class="avatar" alt="Avatar" />
          <div>
            <div id="user-name" style="font-weight:600;">â€”</div>
            <div id="user-openid" class="muted">open_id: â€”</div>
          </div>
        </div>
        <div class="muted" style="margin-top:8px;">Displayed via /v2/user/info with scope user.info.basic.</div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>
      <a href="./terms-of-service.html" target="_blank" rel="noopener noreferrer">Terms of Service</a> |
      <a href="./privacy-policy.html" target="_blank" rel="noopener noreferrer">Privacy Policy</a>
    </p>
  </footer>

  <script>
    // Configure your Login Kit client_key and optional backend base URL for token exchange + user info proxy.
    const CLIENT_KEY = 'sbawbj2jcdabtqkzi0'; // exact Login Kit client_key
    const API_BASE = ''; // e.g., 'https://your-backend.example.com' when you deploy the routes below
    const REDIRECT_URI = window.location.href.split('?')[0]; // must equal the registered Login Kit redirect URI

    const sections = {
      login: document.getElementById('login-section'),
      loading: document.getElementById('loading-section'),
      error: document.getElementById('error-section'),
      success: document.getElementById('success-section'),
      user: document.getElementById('user-card')
    };

    // PKCE helpers (verifier â†’ SHA-256 â†’ Base64URL challenge)
    function generateCodeVerifier() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      return Array.from(crypto.getRandomValues(new Uint8Array(64))).map(b => chars[b % chars.length]).join('');
    }

    async function generateCodeChallenge(verifier) {
      const data = new TextEncoder().encode(verifier);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }

    function showSection(id) {
      Object.values(sections).forEach(s => s.classList.remove('active'));
      sections[id].classList.add('active');
    }

    function showError(message) {
      document.getElementById('error-message').textContent = message || 'Unknown error.';
      showSection('error');
    }

    // Start OAuth with minimal scopes (Login Kit + Content Posting API demo)
    async function startOAuth() {
      showSection('loading');
      try {
        const state = generateCodeVerifier().slice(0, 16);
        const codeVerifier = generateCodeVerifier();
        sessionStorage.setItem('pkce_state', state);
        sessionStorage.setItem('pkce_verifier', codeVerifier);
        const codeChallenge = await generateCodeChallenge(codeVerifier);

        const authUrl = new URL('https://www.tiktok.com/v2/auth/authorize/');
        authUrl.searchParams.append('client_key', CLIENT_KEY);
        authUrl.searchParams.append('response_type', 'code');
        authUrl.searchParams.append('redirect_uri', REDIRECT_URI);
        authUrl.searchParams.append('scope', 'user.info.basic,video.upload,video.publish');
        authUrl.searchParams.append('state', state);
        authUrl.searchParams.append('code_challenge', codeChallenge);
        authUrl.searchParams.append('code_challenge_method', 'S256');

        window.location.href = authUrl.toString();
      } catch (error) {
        showError('Could not initiate authorization. Please ensure your browser supports required crypto functions and try again.');
      }
    }

    // Handle TikTok callback
    async function handleCallback() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');
      const error = params.get('error');
      const errorDescription = params.get('error_description');

      if (error) { showError(`${error}: ${errorDescription || 'Authorization error.'}`); return; }
      if (!code) { showSection('login'); return; }
      if (state !== sessionStorage.getItem('pkce_state')) { showError('Security check failed (state mismatch).'); return; }

      document.getElementById('auth-code').textContent = code;
      showSection('success');

      // Optional demo: fetch user.info.basic via backend after server-side token exchange.
      if (API_BASE) {
        try {
          const token = await exchangeToken(code, sessionStorage.getItem('pkce_verifier'), REDIRECT_URI);
          const profile = await fetchUserInfo(token.access_token);
          renderUser(profile);
        } catch (e) {
          console.warn('User info demo failed:', e);
        }
      }
    }

    // Token exchange (backend) â€” never expose client_secret in the browser.
    async function exchangeToken(code, codeVerifier, redirectUri) {
      const res = await fetch(API_BASE + '/api/tiktok/exchange', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ code, code_verifier: codeVerifier, redirect_uri: redirectUri })
      });
      if (!res.ok) throw new Error('Token exchange failed: ' + res.status);
      return res.json(); // { access_token, open_id, scope, ... }
    }

    // Fetch basic profile (avatar_url, display_name, open_id) via /v2/user/info
    async function fetchUserInfo(accessToken) {
      const res = await fetch(API_BASE + '/api/tiktok/userinfo', {
        headers: { Authorization: 'Bearer ' + accessToken }
      });
      if (!res.ok) throw new Error('User info failed: ' + res.status);
      return res.json(); // proxy of TikTok response
    }

    function renderUser(userJson) {
      // Expected proxy shape: { data: { user: { open_id, display_name, avatar_url, ... } } }
      const u = userJson?.data?.user || {};
      document.getElementById('user-avatar').src = u.avatar_url || '';
      document.getElementById('user-name').textContent = u.display_name || '(no display name)';
      document.getElementById('user-openid').textContent = 'open_id: ' + (u.open_id || '(missing)');
      sections.user.classList.add('active');
    }

    document.getElementById('login-btn').addEventListener('click', startOAuth);
    document.getElementById('retry-btn').addEventListener('click', () => window.location.href = REDIRECT_URI);
    document.getElementById('copy-btn').addEventListener('click', () => {
      const v = document.getElementById('auth-code').textContent;
      navigator.clipboard.writeText(v).then(() => alert('Authorization code copied!'));
    });
    window.addEventListener('load', handleCallback);
  </script>
</body>
</html>
